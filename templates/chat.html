{% extends "base.html" %}

{% block page_title %}–ß–∞—Ç –∫–ª–∞—Å—Å–∞{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% for message in messages %}
        <div class="message-item {% if message.user_id == current_user.id %}my-message{% else %}other-message{% endif %}">
            <div class="message-header">
                <strong>{{ message.user.get_full_name() }}</strong>
                <span class="message-time">{{ message.created_at.strftime('%H:%M') }}</span>
            </div>
            <div class="message-content">{{ message.content }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="chat-input">
        <input type="text" id="chatMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="form-input">
        <button onclick="sendChatMessage()" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
function sendChatMessage() {
    const input = document.getElementById('chatMessageInput');
    const content = input.value.trim();
    
    if (!content) return;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    const button = document.querySelector('.chat-input button');
    button.disabled = true;
    button.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    fetch('/send_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            addMessageToChat(content, true);
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    });
}

function addMessageToChat(content, isMyMessage = true) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${isMyMessage ? 'my-message' : 'other-message'}`;
    
    const now = new Date();
    const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                      now.getMinutes().toString().padStart(2, '0');
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <strong>${isMyMessage ? '–í—ã' : '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}</strong>
            <span class="message-time">${timeString}</span>
        </div>
        <div class="message-content">${content}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ)
function checkNewMessages() {
    fetch('/chat?check_new=true')
    .then(response => response.json())
    .then(data => {
        if (data.new_messages && data.new_messages.length > 0) {
            data.new_messages.forEach(msg => {
                if (msg.user_id !== {{ current_user.id }}) {
                    addMessageToChat(msg.content, false);
                }
            });
        }
    })
    .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error));
}

// –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const header = document.querySelector('.content-header');
    const refreshBtn = document.createElement('button');
    refreshBtn.className = 'btn btn-primary';
    refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
    refreshBtn.onclick = function() {
        location.reload();
    };
    header.appendChild(refreshBtn);
    
    // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});
</script>
{% endblock %}